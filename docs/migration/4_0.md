# Technical Changes in Spartacus 4.0

## Before migrating to Spartacus 4.0

Before the 3.0 release we started to separate libraries based on it's responsibility. With 3.0 we already released few libraries in separate packages (eg. @spartacus/organization, @spartacus/storefinder). We kept moving more libraries in the minor 3.x releases as well. We tried to do that in a no breaking-changes manner. However with each major release we want to pay off tech debt we accumulated during minor releases. Extracted libraries are huge contributor to tech debt, as we keep the same functionality in 2 places. With 4.0 release we will remove the functionality from core libraries (@spartacus/core, @spartacus/storefront, @spartacus/assets and @spartacus/styles) that was already extracted to separate libraries in minor releases.

Along the way we discovered that we had to change few of the bigger modules to accommodate these changes (eg. `B2cStoreFrontModule`, `StorefrontModule` or `CmsLibModule`).

So before you migrate to version 4.0 of libraries we recommend to switch to new app structure that is not using these modules and to switch to new feature libraries if they exists for the features you are using. Below you can find generic guide on how to do it.

### Migrating to new, reference app structure

Before you start to migrate to new app structure read the reasoning behind the change [here](https://sap.github.io/spartacus-docs/reference-app-structure/).

So let's migrate to the new structure step by step.

1. Create `SpartacusModule` under `app/spartacus/spartacus.module.ts` path and add it to `imports` in `AppModule`.
2. Add `BaseStorefrontModule` to imports and exports of `SpartacusModule`. This modules is exported from `@spartacus/storefront` library.
3. Create `SpartacusFeaturesModule` under `app/spartacus/spartacus-features.module.ts` path and add it to `imports` in `SpartacusModule`.
4. Create `SpartacusConfigurationModule` under `app/spartacus/spartacus-configuration.module.ts` path and add it to `imports` in `SpartacusModule`.
5. Move spartacus configuration to `SpartacusConfigurationModule`. That would be the config you pass with `provideConfig`, `provideConfigFactory` or with `withConfig` methods from some of the modules (eg. `B2cStorefrontModule`). We still recommend to use `provideConfig` or `provideConfigFactory` in a providers of the module.
6. Configure `AppRoutingModule`. If you don't have this module, first create it under `app/app-routing.module.ts`. Don't forget to import this module in `AppModule`. In `AppRoutingModule`  configure `RouterModule` with these 3 options:

    ```ts
    RouterModule.forRoot([], {
      anchorScrolling: 'enabled',
      relativeLinkResolution: 'corrected',
      initialNavigation: 'enabled',
    }),
    ```

    Previously this module was configured in `StorefrontModule`, which is now deprecated.
7. Configure ngrx modules in `AppModule`. They were part of the `StorefrontModule`, but similarly like `RouterModule` we require the configuration to be present in application. you need to add to `imports` 2 modules: `StoreModule.forRoot({})` and `EffectsModule.forRoot([])`. Import these modules from `@ngrx/store` and from `@ngrx/effects`.

    ```ts
    @NgModule({
      imports: [
        AppRoutingModule,
        StoreModule.forRoot({}),
        EffectsModule.forRoot([]),
        SpartacusModule
      ],
      ...
    ```

8. Now let's focus on replacing deprecated Spartacus grouping modules

    1. For `B2cStorefrontModule`.
        - config from `B2cStorefrontModule.withConfig` should be already moved to `SpartacusConfigurationModule` and provided with `provideConfig`
        - first add `HttpClientModule` to imports in `AppModule` if it's not present there
        - now add in `SpartacusFeaturesModule` imports, two modules from `@spartacus/storefront`: `StorefrontModule` and `CmsLibModule`. These modules are also deprecated, but we want to migrate the modules step by step. Migration of this modules will be covered in next steps.
        - this module provided few default configs, so add them to your `SpartacusConfigurationModule` if you rely on them

            ```ts
            provideConfig({
              pwa: {
                enabled: true,
                addToHomeScreen: true,
              },
            }),
            provideConfig(layoutConfig),
            provideConfig(mediaConfig),
            ...defaultCmsContentProviders,
            ```

        - remove usage of `B2cStorefrontModule` from your app

    2. Similarly for `B2bStorefrontModule`.
        - config from `B2bStorefrontModule.withConfig` should be already moved to `SpartacusConfigurationModule` and provided with `provideConfig`
        - add `HttpClientModule` to imports in `AppModule` if it's not present there
        - add in `SpartacusFeaturesModule` imports few modules: `StorefrontModule`, `CmsLibModule` from `@spartacus/storefront` and `CostCenterModule.forRoot()` from `@spartacus/core`
        - this module provided few default configs, so add them to your `SpartacusConfigurationModule` if you rely on them

            ```ts
            provideDefaultConfig(layoutConfig),
            provideDefaultConfig(mediaConfig),
            provideDefaultConfig(defaultB2bOccConfig),
            provideDefaultConfig(defaultB2bCheckoutConfig),
            ...defaultCmsContentProviders,
            ```

        - remove usage of `B2bStorefrontModule` from your app

    3. Now let's replace `StorefrontModule`
        - you should have configured `RouterModule` in `AppRoutingModule`
        - in `AppModule` you should already have `StoreModule.forRoot({})` and `EffectsModule.forRoot([])` present in `imports`
        - add `AsmModule` from `@spartacus/storefront` to imports in `SpartacusFeaturesModule`
        - add `StorefrontFoundationModule` to `SpartacusFeaturesModule` imports. We will migrate it in next steps
        - Add `MainModule` to `SpartacusFeaturesModule` imports
        - Add `SmartEditModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - Add `PersonalizationModule.forRoot` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - Add `OccModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - Add `ProductDetailsPageModule` and `ProductListingPageModule` from `@spartacus/storefront` to imports in `SpartacusFeaturesModule`
        - Add `ExternalRoutesModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - remove usage of `StorefrontModule` from you app

    4. Migrating `CmsLibModule`
        - add imports listed below from `@spartacus/storefront` directly to imports in `SpartacusFeaturesModule`:

            ```ts
            AnonymousConsentManagementBannerModule,
            AsmModule,
            HamburgerMenuModule,
            CmsParagraphModule,
            LinkModule,
            BannerModule,
            CategoryNavigationModule,
            NavigationModule,
            FooterNavigationModule,
            BreadcrumbModule,
            SearchBoxModule,
            SiteContextSelectorModule,
            QualtricsModule,
            AddressBookModule,
            OrderHistoryModule,
            OrderCancellationModule,
            OrderReturnModule,
            ReturnRequestListModule,
            ReturnRequestDetailModule,
            ProductListModule,
            ProductFacetNavigationModule,
            ProductTabsModule,
            ProductCarouselModule,
            ProductReferencesModule,
            OrderDetailsModule,
            PaymentMethodsModule,
            ConsentManagementModule,
            CartComponentModule,
            TabParagraphContainerModule,
            OrderConfirmationModule,
            ProductImagesModule,
            ProductSummaryModule,
            ProductVariantsModule,
            ProductIntroModule,
            CheckoutComponentModule,
            BannerCarouselModule,
            MyCouponsModule,
            WishListModule,
            NotificationPreferenceModule,
            MyInterestsModule,
            StockNotificationModule,
            ReplenishmentOrderHistoryModule,
            ReplenishmentOrderConfirmationModule,
            ReplenishmentOrderDetailsModule,

            // moved to user lib

            UserComponentModule, // almost empty

            CloseAccountModule,
            UpdateEmailModule,
            UpdatePasswordModule,
            UpdateProfileModule,
            ForgotPasswordModule,
            ResetPasswordModule,
            ```

        - remove usage of `CmsLibModule` from your app

    5. Migrating `MainModule`
        - add `AnonymousConsentsDialogModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - remove usage of `MainModule` from you app
    6. Migrating `StorefrontFoundationModule`
        - add `AuthModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - add `AnonymousConsentsModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `CartModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `CheckoutModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `UserModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `ProductModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `CartPageEventModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - add `PageEventModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - add `ProductPageEventModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - remove usage of `StorefrontFoundationModule` from your app


    // OccModule
    // migrate to latest 3.x version
    // EventsModule
    // ViewConfigModule
## Breaking Changes Introduced in 4.0

### Removal of grouping modules

In 4.0 release we removed few modules that were grouping feature modules and provided some default configuration.

To migrate them check this section: `Before migrating to Spartacus 4.0`

- removed `B2cStorefrontModule` from `@spartacus/storefront`
- removed `B2bStorefrontModule` from `@spartacus/setup`
- removed `StorefrontModule` from `@spartacus/storefront`
- removed `CmsLibModule` from `@spartacus/storefront`
- removed `MainModule` from `@spartacus/storefront`
- removed `StorefrontFoundationModule` from `@spartacus/storefront`
